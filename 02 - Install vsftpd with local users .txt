========================================================================================
Study Center....: Universidad Técnica Nacional
Campus..........: Pacífico
College career..: Tecnologías de Información
Course..........: ITI-621 - Tecnologías y Sistemas Web III
School period...: 3-2025
Document........: Install VSFTP service with local user.txt
Goals...........: Install 
					- VSFTP service.
					- Publish 
Professor.......: Jorge Ruiz (york)
Student.........: Luis Alejandro López Reyes.
========================================================================================

Recursos de la VM.
8ram.
100gb.
4 processors .

00 - Credenciales de la VM.

webmybox
webmybox
User: webmybox01
Password: webmybox1
webmybox1

-- Comando para apagar de forma segura la VM.

	sudo shutdown -h now

-- Reglas de reenvio de puertos en el adaptador NAT de VB.

| Nombre    | Protocolo | Puerto anfitrión | Puerto invitado | IP invitado |
| --------- | --------- | ---------------- | --------------- | ----------- |
| SSH_MYBOX | TCP       | 2240             | 22              | 10.0.2.15   |
| FTP_MYBOX | TCP       | 2121             | 21              | 10.0.2.15   |
| HTTP_MYBOX | TCP       | 8080             | 80              | 10.0.2.15   |
| HTTPS_MYBOX | TCP       | 8443             | 443              | 10.0.2.15   |
| PASV1     | TCP       | 30000            | 30000           | 10.0.2.15   |
| PASV2     | TCP       | 30001            | 30001           | 10.0.2.15   |
| PASV3     | TCP       | 30002            | 30002           | 10.0.2.15   |
| PASV4     | TCP       | 30003            | 30003           | 10.0.2.15   |
| PASV5     | TCP       | 30004            | 30004           | 10.0.2.15   |
| PASV6     | TCP       | 30005            | 30005           | 10.0.2.15   |

-- Conexión remota por SSH a la VM "webmybox01" en PowerShell.

	ssh webmybox01@localhost -p 2240

-- PD: Si se muestra un encabezado como este:

@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 
@ WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED! @ 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ 
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY! Someone could be eavesdropping on you right now (man-in-the-middle attack)! 
It is also possible that a host key has just been changed. 
The fingerprint for the ED25519 key sent by the remote host is SHA256:Ai4jVG+MPP7R+muWsgnE8yWDRzbD+CWMI3lD+MIRu2E. 
Please contact your system administrator. 
Add correct host key in C:\\Users\\Admin/.ssh/known_hosts to get rid of this message. 
Offending ECDSA key in C:\\Users\\Admin/.ssh/known_hosts:20 Host key for [localhost]:2240 has changed and you have requested strict checking. 
Host key verification failed.

Se soluciona de la siguiente forma: 

	notepad C:\Users\Admin\.ssh\known_hosts

Buscar la línea según el mensaje de error (en este caso es la 20):

	Offending ECDSA key in C:\\Users\\Admin/.ssh/known_hosts:20

	y borrar esa línea completa (puede contener algo como [localhost]:2240 ...).

Se guarda y se cierra el archivo.

Luego vuelve a intentar:

	ssh webmybox@localhost -p 2240

01 - Instalar y configurar servicio de FTP
	
	sudo su

	apt-get install vsftpd

	apt install net-tools

	mkdir /etc/vsftpd
	mkdir /etc/vsftpd/vacio
	nano /etc/vsftpd/chroot_list		# Este archivo se deja en blanco

			salvar documento: ctrl + o 
			salir documento:  ctrl + x
		
	nano /etc/shells
		Agregar al final la línea:

			/bin/false

		salvar documento: ctrl + o 
		salir documento:  ctrl + x

	Se procede a modificar el archivo vsftpd.conf, para configurar el comportamiento que 
	habrá de tener el servicio de FTP.

	nano /etc/vsftpd.conf

		La siguiente es una lista de las variables que deben modificarse y mantenerse activas 
		para que el servicio de FTP funcione como se espera.  Las variables se configuran de 
		acorde a su aparición de principio a fin.
		
			listen=NO
			anonymous_enable=NO
			write_enable=YES
			local_umask=022

			dirmessage_enable=YES
			use_localtime=YES
			xferlog_enable=YES

			connect_from_port_20=YES
			xferlog_file=/var/log/vsftpd.log

			chroot_local_user=YES 		 # configurar la segunda
			chroot_list_enable=YES
			allow_writeable_chroot=YES		# agregar esta línea que no existe

			chroot_list_file=/etc/vsftpd/chroot_list
			secure_chroot_dir=/etc/vsftpd/vacio
			pam_service_name=vsftpd

			agregar estas instrucciones al final del archivo
			local_max_rate=2097152	
			max_clients=100
			max_per_ip=10
			pasv_enable=YES
			pasv_min_port=30000
			pasv_max_port=30005
			pasv_addr_resolve=YES
			pasv_address=127.0.0.1
			listen=YES
			listen_ipv6=NO

		salvar documento: ctrl + o 
		salir documento:  ctrl + x

02 - Reiniciar el servicio de vsftpd
	
	/etc/init.d/vsftpd restart

	apt install nmap -y

		Utilizando nmap + [ip de su servidor], deberían de observarse los puertos:
			80 para http
			22 para ssh
			21 para ftp

	ifconfig	# se toma la ip

	nmap 10.0.2.15

		Si el puerto 21 no aparece en la lista, se debe revisar la configuración del 
		servicio de ftp

03 - Configurar las cuentas de los usuarios de FTP

	mkdir /home/ftpusers	carpeta física donde se grabarán los archivos de los usuarios
	mkdir /utiles			carpeta que contendrá archivos batch de uso continuo
	mkdir -p /var/www/html/york

	nano /utiles/addftpuser.sh	
	
		Escribir el siguiente código

		mkdir /home/ftpusers/$1
		groupadd $1
		useradd -d /home/ftpusers/$1 -s /bin/false -g $1 $1
		chown -R $1:$1 /home/ftpusers/$1
		chmod -R 755 /home/ftpusers/$1
		passwd $1
		ln /home/ftpusers/$1 /var/www/html/$1 -s

		salvar documento: ctrl + o 
		salir documento:  ctrl + x

	chmod +x  /utiles/addftpuser.sh

04. Validar función del batch anterior:

	/utiles/./addftpuser.sh <usuario de prueba>
	
	Asignar contraseña y validarla (ojo no se mira cuando se escribe)

-- Reiniciar el servicio.

	systemctl restart vsftpd
	systemctl status vsftpd --no-pager

05. Abrir el Filezilla Client en Windows y probar datos de autentificación

Usuario de prueba:
Host: localhost
Usuario: usuario1
Contraseña: usuario1mybox
Puerto: 2121